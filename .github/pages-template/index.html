<!doctype html>
<html lang="en">

<head>
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="msapplication-starturl" content="/pretty-claws/">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" sizes="334x334" href="clawnail.png">
  <link rel="apple-touch-icon" sizes="334x334" href="clawnail.png">
</head>

<body style="margin: 0px;">
  <style>
    canvas {
      height: 100vh !important;
    }
    ul {
      list-style: square;
    }
  </style>
  <noscript>
    <h3>
      oh. yeah, this is all js. kinda.
    </h3>
  </noscript>
  <ul id="downloading">
    <li>here comes some pretty claws</li>
  </ul>
  <script type="module">
    function xhrFetch(url) {
      const xhr = new XMLHttpRequest();
      const li = document.getElementById("downloading").appendChild(document.createElement("li"));
      li.innerText = `${url}: starting`;
      return new Promise((resolve) => {
        xhr.addEventListener("progress", (event) => {
          if (event.lengthComputable) {
            const progress = event.loaded / event.total * 100;
            const mib = event.total / 1024 / 1024;
            li.innerText = `${url}: ${progress.toFixed(1)}% of ${mib.toFixed(2)}MiB`;
          }
        });
        xhr.addEventListener("loadend", () => {
          const success = xhr.readyState === 4 && xhr.status === 200;
          const blob = xhr.response
          resolve({ success, blob });
        });
        xhr.responseType = "blob";
        xhr.open("GET", url, true);
        xhr.send();
      });
    }

    async function main() {
      const ul = document.getElementById("downloading");
      const fetches = [
        xhrFetch("./pretty-claws.js"),
        xhrFetch("./pretty-claws_bg.wasm"),
      ];
      const responses = await Promise.all(fetches);
      if (responses.find((r) => !r.success)) {
        console.log("load failure");
        ul.appendChild(document.createElement("li")).innerText = "load failure";
        return;
      }
      ul.appendChild(document.createElement("li")).innerText = "starting bevy ...";
      const objects = responses.map((r) => URL.createObjectURL(r.blob));
      const module = await import(objects[0]);
      module.default(objects[1]).catch((error) => {
        if (!error.message.startsWith("Using exceptions for control flow, don't mind me. This isn't actually an error!")) {
          throw error;
        }
      });
      ul.style.display = "none";
    }
    main().catch(console.error);
  </script>
</body>

</html>