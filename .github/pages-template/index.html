<!doctype html>
<html lang="en">

<head>
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="msapplication-starturl" content="/pretty-claws/">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" sizes="334x334" href="clawnail.png">
  <link rel="apple-touch-icon" sizes="334x334" href="clawnail.png">
</head>

<body style="margin: 0px;">
  <style>
    canvas {
      height: 100vh !important;
    }
    ul {
      list-style: square;
    }
  </style>
  <noscript>
    <h3>
      oh. yeah, this is all js. kinda.
    </h3>
  </noscript>
  <ul id="downloading">
    <li>here comes some pretty claws</li>
  </ul>
  <script type="module">
    async function progressFetch(url) {
      const li = document.getElementById("downloading").appendChild(document.createElement("li"));
      li.innerText = `${url}: starting`;
      const resp = await fetch(url);
      const reader = resp.body.getReader();
      const byteLength = Number(resp.headers.get('content-length'));
      var bytesRead = 0;
      while (true) {
        const {done, value} = await reader.read();
        if (done) {
          li.innerText += ` done!`;
          break;
        }
        bytesRead += value.length;
        if (byteLength) {
          const progress = bytesRead / byteLength * 100;
          const mib = bytesRead / 1024 / 1024;
          li.innerText = `${url}: ${progress.toFixed(1)}% of ${mib.toFixed(2)}MiB`;
        } else {
          const kib = bytesRead / 1024;
          li.innerText = `${url}: ${kib.toFixed(1)}KiB down...`;
        }
      }
      return resp
    }

    console.log('starting js main');
    async function main() {
      const ul = document.getElementById("downloading");
      const fetches = [
        progressFetch("./pretty-claws.js"),
        progressFetch("./pretty-claws_bg.wasm"),
      ];
      const responses = await Promise.all(fetches);
      if (responses.find((r) => !r.ok)) {
        console.log("load failure", responses);
        ul.appendChild(document.createElement("li")).innerText = "load failure";
        return;
      }
      ul.appendChild(document.createElement("li")).innerText = "loading wasm ...";
      const module = await import('./pretty-claws.js');
      module.default().catch((error) => {
        if (!error.message.startsWith("Using exceptions for control flow, don't mind me. This isn't actually an error!")) {
          throw error;
        }
      });
      ul.appendChild(document.createElement("li")).innerText = "starting bevy ...";
    }
    main().catch(console.error);
  </script>
</body>

</html>